<!DOCTYPE html>
<html lang="es">
<head>
  <!-- Gate: SOLO admin o small -->
  <script>
  (function(){
    const ok    = localStorage.getItem('dw_auth') === 'ok';
    const scope = (localStorage.getItem('dw_scope') || '').trim().toLowerCase();
    let   home  = (localStorage.getItem('dw_home')  || '').trim();
    if(!home) home = (scope === 'small' ? 'dashboard_s.html' : 'dashboard.html');

    if(!ok){
      location.href = 'login.html?next=' + encodeURIComponent('dashboard_s.html');
      return;
    }

    const allow = (scope === 'admin' || scope === 'small');
    if(!allow){
      const here = location.pathname.split('/').pop() || 'dashboard_s.html';
      if (here !== home) location.replace(home);
    }
  })();
  </script>

  <meta charset="utf-8">
  <title>Dashboard — DoberWhite Capital</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="assets/css/main.css">

  <style>
    :root{
      --dw-green:#00e18e; --dw-border:#e7eaf0; --dw-text:#111; --dw-muted:#6b7280;
      --dw-ink:#111; --dw-panel:#fff; --line:#e7eaf0;
    }
    body{background:#fff;color:var(--dw-text)}
    .dw-wrap{padding:16px}
    .dw-layout{display:grid;grid-template-columns:320px 1fr;gap:16px}
    .dw-aside{background:#fff;border:1px solid var(--dw-border);border-radius:12px;padding:14px}
    .dw-aside h4{margin:0 0 8px;font-weight:700}
    .dw-kpis{list-style:none;margin:0;padding:0;border-top:2px solid #111}
    .dw-kpis li{display:flex;justify-content:space-between;gap:12px;padding:10px 0;border-bottom:1px solid #e6e6e6}
    .dw-kpis li span:first-child{color:var(--dw-muted)}
    .dw-kpis li span:last-child{font-variant-numeric:tabular-nums}
    .dw-kpis .neg{color:#c62828}
    .dw-section{margin-top:6px}
    .dw-subtitle{font-style:italic;font-weight:700;text-align:center;margin:0 0 6px;color:#222;opacity:.9}
    .dw-grid{display:grid;gap:16px;grid-template-columns:repeat(12,1fr)}
    .dw-card{grid-column:span 4;background:#fff;border:1px solid var(--dw-border);border-radius:12px;box-shadow:0 2px 8px rgba(17,24,39,.06)}
    .dw-card h3{margin:12px 14px 0;font-weight:700}
    .dw-chart{height:260px;width:100%}
    @media (max-width:1100px){.dw-card{grid-column:span 6}.dw-layout{grid-template-columns:1fr}}
    @media (max-width:700px){.dw-card{grid-column:span 12}.dw-chart{height:220px}}

    /* Negativos en rojo en Ratio YTD (se marca con data-val más abajo) */
    .dw-kpis li span:last-child[data-val^="-"]{color:#c62828}
  </style>

  <!-- ECharts -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

  <!-- Fuente de datos SOLO para small -->
  <script> window.DW_DATA_URL = 'assets/data/dashboard/data_small.json'; </script>

  <!-- Render principal -->
  <script src="assets/js/dashboard.js"></script>

  <!-- ===== Overrides SOLO para dashboard_s.html ===== -->
  <script>
    (function(){
      // Paleta fija para Allocation (verde claro, rojo, naranjo, cian)
      const PIE_FIXED = {
        'XAUUSD':'#86efac',   // verde claro
        'GBPUSD':'#ef4444',   // rojo
        'NAS100':'#f59e0b',   // naranjo
        'NDX100':'#f59e0b',   // alias
        'USDJPY':'#06b6d4',   // cian
        'BTCUSD':'#06b6d4',
        'EURUSD':'#86efac'
      };

      const brand = '#00e18e', red = '#ef9a9a', axis = '#9aa0a6', labelColor = '#374151';
      const baseGrid   = { left: 36, right: 20, top: 36, bottom: 28, containLabel: true };

      const axisX = (labels, opts={}) => ({
        type:'category',
        data:labels,
        axisLabel:{ color:'#555', interval: opts.showAll ? 0 : 'auto', hideOverlap: !opts.showAll, margin:10 },
        axisTick:{ alignWithLabel:true },
        axisLine:{ onZero:true, lineStyle:{ color:axis } },
        splitLine:{ show:false }
      });
      const axisY = (opts={}) => ({
        type:'value',
        axisLabel:{ color:'#555', show: !(opts.hideLabels) },
        axisTick:{ show:false },
        axisLine:{ show:true, lineStyle:{ color:axis } },
        splitLine:{ show:false }
      });

      // === Allocation ===
      window.optPie = function(labels, values){
        const total = values.reduce((a,b)=>a+b,0) || 1;
        return {
          legend:{ bottom: 0, itemWidth:12, itemHeight:12, textStyle:{ color:'#444' },
            formatter:(name)=>{ const i=labels.indexOf(name); const p=Math.round(values[i]*100/total); return `${name}  ${p}%`; } },
          tooltip:{ trigger:'item', formatter: ({name,percent}) => `${name}: ${percent}%` },
          series:[{
            type:'pie', radius:['46%','68%'], center:['50%','44%'], label:{ show:false },
            data: labels.map((n,i)=>({ name:n, value:values[i], itemStyle:{ color: PIE_FIXED[n] || '#94a3b8' } }))
          }]
        };
      };

      // === Balance (único gráfico con eje Y visible) ===
      window.optLine = function(labels, values){
        return {
          grid: baseGrid,
          xAxis: axisX(labels),
          yAxis: axisY({hideLabels:false}),
          tooltip:{trigger:'axis'},
          series:[{ type:'line', smooth:true, symbol:'circle', symbolSize:6,
            lineStyle:{width:2,color:brand}, areaStyle:{opacity:.08,color:brand}, data:values }]
        };
      };

      // === Barras genéricas sin eje Y ===
      const labelTop = { show:true, position:'top', color:labelColor, fontSize:10, formatter:p=>p.value };
      window.optBar = function(labels, values, opts={}){
        return {
          grid: baseGrid,
          xAxis: axisX(labels, { showAll: !!opts.showAll }),
          yAxis: axisY({ hideLabels:true }),
          tooltip:{ trigger:'axis' },
          series:[{
            type:'bar', barMaxWidth:28, label: labelTop,
            data: values.map(v=>({ value:v, itemStyle:{ color: v>=0 ? brand : red } }))
          }]
        };
      };

      // === Barras horizontales (Average Position) ===
      window.optBarH = function(labels, values){
        return {
          grid: { ...baseGrid, right: 48 },
          xAxis: axisY({ hideLabels:true }),
          yAxis:{ type:'category', data:labels, axisLabel:{ color:'#555' }, axisLine:{ lineStyle:{ color:axis } }, splitLine:{ show:false } },
          tooltip:{ trigger:'axis' },
          series:[{
            type:'bar', barMaxWidth:22,
            label:{ show:true, position:'right', color:labelColor, fontSize:10, formatter:p=>p.value },
            data: values.map(v=>({ value:v, itemStyle:{ color: v>=0 ? brand : red } }))
          }]
        };
      };

      // === Distribution USD: etiquetas del mismo estilo (fuera de barras) ===
      window.optDist = function(d){
        const maxCount = Math.max(...d.counts, 0);
        const minPnl   = Math.min(...d.pnl, 0);
        const maxAbs   = Math.max(maxCount, Math.abs(minPnl));
        const head     = Math.ceil(maxAbs * 1.15);

        return {
          grid: baseGrid,
          legend:{ top:6, right:8, data:['n°','P&L'], textStyle:{ color:'#444' } },
          tooltip:{ trigger:'axis' },
          xAxis: axisX(d.labels, { showAll:true }),
          yAxis: {
            type:'value', min:-head, max:head,
            splitLine:{ show:false }, axisLabel:{ show:false }, axisTick:{ show:false },
            axisLine:{ show:true, lineStyle:{ color:axis } }
          },
          series:[
            { name:'n°',  type:'bar', barMaxWidth:26,
              itemStyle:{ color:'#cbd5e1' },
              label:{ show:true, position:'top', color:labelColor, fontSize:10, formatter:p=>p.value },
              data:d.counts, z:1 },
            { name:'P&L', type:'bar', barMaxWidth:26, barGap:'40%',
              itemStyle:{ color:(p)=> (p.value<0 ? red : brand) },
              label:{ show:true, position:'top', color:labelColor, fontSize:10, formatter:p=>p.value },
              data:d.pnl, z:2 }
          ]
        };
      };

      // Marca negativos en rojo en la lista KPI
      window.addEventListener('DOMContentLoaded', ()=>{
        const ul = document.getElementById('dw-kpis');
        const mark = () => {
          if(!ul) return;
          ul.querySelectorAll('li span:last-child').forEach(s=>{
            const t = s.textContent?.replace(/\s/g,'') || '';
            s.setAttribute('data-val', t.replace(',','.'));
          });
        };
        const obs = new MutationObserver(mark);
        if(ul){ obs.observe(ul,{childList:true,subtree:true,characterData:true}); }
        mark();
      });
    })();
  </script>
  <!-- ===== Fin overrides ===== -->
</head>

<body>
  <script src="assets/js/main.js" defer></script>
  <script src="assets/js/logout.js" defer></script>

  <!-- Header -->
  <header class="site-header">
    <div class="container bar">
      <a class="brand" href="index.html"><span class="word">DOBERWHITE</span> <span class="thin">CAPITAL</span></a>
      <a class="menu-button" href="#menu">Menú</a>
    </div>

    <!-- Barra de usuario (botón Cerrar sesión) -->
    <div class="container mini" style="display:flex;justify-content:flex-end;gap:12px;align-items:center;margin-top:8px">
      <span id="dw-user" style="opacity:.75"></span>
      <button id="dw-logout"
              style="border:1px solid var(--line);background:var(--panel);color:var(--ink);
                     padding:6px 10px;border-radius:10px;cursor:pointer">
        Cerrar sesión
      </button>
    </div>
  </header>

  <!-- Menú (esta página small) -->
  <nav class="site-menu" id="menu" aria-hidden="true">
    <div class="inner">
      <ul>
        <li><a href="index.html">Inicio</a></li>
        <li><a href="institucionales.html">Servicios institucionales</a></li>
        <li><a href="particulares.html">Servicios particulares</a></li>
        <li><a href="cursos.html">Cursos & seminarios</a></li>
        <li><a href="valores.html">Nuestros valores</a></li>
        <li class="active"><a href="dashboard_s.html">Dashboard</a></li>
        <li><a class="primary" href="contacto.html">Agendar reunión</a></li>
      </ul>
    </div>
  </nav>

  <!-- Hero -->
  <section class="hero" style="background:#fff;color:#111;border-bottom:1px solid #eee">
    <div class="container">
      <h1 style="color:#111">Dashboard</h1>
      <p class="sub" id="dw-periodo" style="color:#444">Performance SYNC (Small)</p>
    </div>
  </section>

  <!-- Dashboard -->
  <section class="dw-wrap">
    <div class="container">
      <div class="dw-layout">
        <aside class="dw-aside">
          <div class="dw-subtitle">Ratio <span style="font-weight:400">YTD</span></div>
          <ul id="dw-kpis" class="dw-kpis"></ul>
        </aside>

        <div>
          <div class="dw-section">
            <div class="dw-subtitle">P&L</div>
            <div class="dw-grid">
              <div class="dw-card"><h3>Balance USD</h3><div id="ch_balance" class="dw-chart"></div></div>
              <div class="dw-card"><h3>Montly USD</h3><div id="ch_monthly" class="dw-chart"></div></div>
              <div class="dw-card"><h3>Distribution USD</h3><div id="ch_distribution" class="dw-chart"></div></div>
            </div>
          </div>

          <div class="dw-section">
            <div class="dw-subtitle">Assets</div>
            <div class="dw-grid">
              <div class="dw-card"><h3>Allocation</h3><div id="ch_allocation" class="dw-chart"></div></div>
              <div class="dw-card"><h3>P&L USD(Neto)</h3><div id="ch_pl_assets" class="dw-chart"></div></div>
              <div class="dw-card"><h3>Win rate</h3><div id="ch_wr_assets" class="dw-chart"></div></div>
            </div>
          </div>

          <div class="dw-section">
            <div class="dw-subtitle">Miscellaneous</div>
            <div class="dw-grid">
              <div class="dw-card"><h3>Distribution trading days</h3><div id="ch_days_dist" class="dw-chart"></div></div>
              <div class="dw-card"><h3>Performance day</h3><div id="ch_days_perf" class="dw-chart"></div></div>
              <div class="dw-card"><h3>Average Position</h3><div id="ch_avg_pos" class="dw-chart"></div></div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </section>

  <footer class="site-footer" style="background:#fff;color:#111;border-top:1px solid #eee">
    <div class="container mini">
      <div>El rendimiento pasado no garantiza resultados futuros. Invertir implica riesgo de perder.</div>
      <div style="margin-top:8px">&copy; DoberWhite 2025 · Design: Ariel Salazar</div>
    </div>
  </footer>

  <!-- Profitability a 1 decimal + parches de etiquetas % -->
  <script>
  (async function () {
    const nf1 = new Intl.NumberFormat('es-CL', { minimumFractionDigits: 1, maximumFractionDigits: 1 });

    const primary = (typeof window !== 'undefined' ? window.DW_DATA_URL : null);
    const CANDIDATES = [ primary, 'assets/data/dashboard/data_small.json', 'assets/data/dashboard/data.json' ]
      .filter(Boolean);

    let json = null;
    for (const url of CANDIDATES) {
      try {
        const res = await fetch(url + '?v=' + Date.now(), { cache: 'no-store' });
        if (res.ok) { json = await res.json(); break; }
      } catch (_) {}
    }

    // Actualiza Profitability a 1 decimal y marca negativos
    function apply(val) {
      const ul = document.getElementById('dw-kpis');
      if (!ul) return false;
      const li = [...ul.querySelectorAll('li')]
        .find(x => x.querySelector('span:first-child')?.textContent?.trim() === 'Profitability');
      if (!li) return false;
      const v = Number(val);
      if (!Number.isFinite(v)) return false;
      const target = li.querySelector('span:last-child');
      target.textContent = nf1.format(v) + '%';
      target.setAttribute('data-val', v.toString());
      return true;
    }
    if (json?.kpis && typeof json.kpis["Profitability"] === 'number') apply(json.kpis["Profitability"]);

    // ---- PARCHE %: Win rate, Distribution trading days, Performance day ----
    const LABEL_COLOR = '#374151';
    function patchPercentChart(domId){
      const el = document.getElementById(domId);
      if (!el) return false;
      const inst = echarts.getInstanceByDom(el);
      if (!inst) return false;

      const opt = inst.getOption();
      if (opt && Array.isArray(opt.series)) {
        opt.series.forEach(s=>{
          s.label = { show:true, position:'top', color:LABEL_COLOR, fontSize:10, formatter:(p)=> `${p.value}%` };
        });
      }
      opt.tooltip = { trigger:'axis', valueFormatter: (v)=> `${v}%` };
      inst.setOption(opt, true);
      return true;
    }

    let tries = 0;
    const timer = setInterval(()=>{
      const a = patchPercentChart('ch_wr_assets');
      const b = patchPercentChart('ch_days_dist');
      const c = patchPercentChart('ch_days_perf');
      tries++;
      if ((a && b && c) || tries > 40){ clearInterval(timer); }
    }, 150);
  })();
  </script>
</body>
</html>

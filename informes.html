<!DOCTYPE HTML>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Informes — DoberWhite Capital</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="assets/css/main.css" />
  <noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
  <style>
    .muted{opacity:.75}
    .container{max-width:1200px;margin:0 auto;padding:0 1.5rem}
    .toolbar{display:flex;gap:.6rem;align-items:center;flex-wrap:wrap;margin:.5rem 0 1rem}
    .toolbar input[type="search"], .toolbar select{height:2.6rem}
    .count{font-size:.9rem;opacity:.8}

    /* VISOR */
    #viewer .frame-wrap{position:relative;border-radius:12px;overflow:hidden;background:#0e111a;border:1px solid rgba(255,255,255,.06)}
    #preview{width:100%;height:72vh;border:0;display:none}
    #filename{font-weight:600}
    .viewer-actions{margin-left:auto;display:flex;gap:.5rem}
    .tall #preview{height:90vh}

    /* LISTA */
    .group{margin:1.2rem 0 .6rem}
    .group h4{margin:0 0 .4rem}
    .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:1rem}
    .card{background:#1f2330;border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:1rem}
    .row{display:flex;align-items:center;gap:.6rem}
    .icon{width:36px;height:36px;border-radius:10px;background:#2a3042;display:grid;place-items:center;font-weight:700}
    .title{margin:.4rem 0 .2rem;font-weight:700;line-height:1.25}
    .date{font-size:.9rem;opacity:.9}
  </style>
</head>
<body class="is-preload">
<div id="wrapper">

  <header id="header">
    <a href="index.html" class="logo"><strong>DoberWhite</strong> <span>Capital</span></a>
    <nav><a href="#menu">Menú</a></nav>
  </header>

  <nav id="menu">
    <ul class="links">
      <li><a href="index.html">Inicio</a></li>
      <li><a href="institucionales.html">Servicios institucionales</a></li>
      <li><a href="particulares.html">Servicios particulares</a></li>
      <li><a href="trading.html">Trading algorítmico</a></li>
      <li><a href="cursos.html">Cursos & seminarios</a></li>
      <li><a href="valores.html">Nuestros valores</a></li>
      <li><a href="rendimientos.html">Rendimientos</a></li>
      <li><a href="contacto.html" class="button primary">Agendar reunión</a></li>
    </ul>
  </nav>

  <!-- VISOR ARRIBA -->
  <section class="container" style="margin-top:1.2rem">
    <header class="major"><h2 style="margin-bottom:.2rem">Visor</h2></header>
    <div class="toolbar" id="viewerTools" style="margin-top:.2rem">
      <span id="filename" class="muted">Selecciona un informe para visualizarlo.</span>
      <div class="viewer-actions">
        <button id="btnFull" class="button small">Pantalla completa</button>
        <a id="btnTab" class="button small" href="#" target="_blank" rel="noopener">Abrir en pestaña</a>
      </div>
    </div>
    <div id="viewer" class="frame-wrap">
      <!-- IMPORTANTE: sin sandbox para evitar bloqueos de PDF -->
      <iframe id="preview"></iframe>
    </div>
  </section>

  <!-- LISTADO -->
  <div id="main">
    <section>
      <div class="inner container">
        <div id="authBox">
          <button id="btnLogin" class="button primary small">Entrar con Google</button>
          <p class="muted" style="margin:.4rem 0 1rem">Solo correos autorizados.</p>
        </div>

        <div id="userBox" style="display:none; margin-bottom:.5rem;display:flex;gap:.5rem;align-items:center">
          <span class="muted" id="userEmail">-</span>
          <button id="btnLogout" class="button small">Salir</button>
        </div>

        <div class="toolbar" id="tools" style="display:none">
          <input id="q" type="search" placeholder="Buscar informe..." style="flex:1">
          <select id="order">
            <option value="desc">Más recientes</option>
            <option value="asc">Más antiguos</option>
          </select>
          <span id="count" class="count"></span>
        </div>

        <div id="list"></div>
        <div id="emptyMsg" class="muted" style="display:none">Aún no hay informes.</div>
      </div>
    </section>
  </div>

  <footer id="footer">
    <div class="inner">
      <p class="disclaimer">Contenido privado. Las URLs expiran automáticamente.</p>
      <ul class="copyright"><li>&copy; DoberWhite 2025</li></ul>
    </div>
  </footer>

</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // === SUPABASE CONFIG ===
  const SUPABASE_URL  = 'https://pmwdminfezdrzrjrzuei.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBtd2RtaW5mZXpkcnpyanJ6dWVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0NzQ2NTcsImV4cCI6MjA3MzA1MDY1N30.XnLcqfobjL0WakJ7D-UFDxpcYVKfVSpGt2DDW0Z-jSM';
  const BUCKET = 'informes';
  const ALLOWLIST = ['asvglobalinvest@gmail.com']; // en minúsculas

  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {
    auth:{ persistSession:true, autoRefreshToken:true, detectSessionInUrl:true, flowType:'pkce' }
  });

  // UI refs
  const authBox  = document.getElementById('authBox');
  const userBox  = document.getElementById('userBox');
  const userEmail= document.getElementById('userEmail');
  const btnLogin = document.getElementById('btnLogin');
  const btnLogout= document.getElementById('btnLogout');

  const tools    = document.getElementById('tools');
  const q        = document.getElementById('q');
  const orderSel = document.getElementById('order');
  const countEl  = document.getElementById('count');
  const listBox  = document.getElementById('list');
  const emptyMsg = document.getElementById('emptyMsg');

  const preview  = document.getElementById('preview');
  const filename = document.getElementById('filename');
  const btnTab   = document.getElementById('btnTab');
  const btnFull  = document.getElementById('btnFull');
  const viewer   = document.getElementById('viewer');

  const fmt = iso => new Date(iso||Date.now()).toLocaleDateString('es-CL',{year:'numeric',month:'long',day:'2-digit'});
  const ext = n => (n.split('.').pop()||'').toLowerCase();
  const nice= n => n.replace(/\.[^.]+$/,'').replace(/[-_]+/g,' ').replace(/\s+/g,' ').trim();

  let allFiles = [], filtered = [], currentURL = '';

  function groupByMonth(items){
    const map = {};
    items.forEach(o=>{
      const d = new Date(o.updated_at||o.created_at||Date.now());
      const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      (map[key] = map[key] || []).push(o);
    });
    return Object.entries(map).sort((a,b)=> a[0] < b[0] ? 1 : -1);
  }

  function render(){
    listBox.innerHTML='';
    if(!filtered.length){ emptyMsg.style.display='block'; countEl.textContent=''; return; }
    emptyMsg.style.display='none';
    countEl.textContent = `${filtered.length} informes`;

    const groups = groupByMonth(filtered);
    groups.forEach(([key,items])=>{
      const [y,m] = key.split('-');
      const h = document.createElement('div');
      h.className='group';
      h.innerHTML = `<h4>${y} — ${new Date(+y, +m-1, 1).toLocaleDateString('es-CL',{month:'long'}).replace(/^./,c=>c.toUpperCase())}</h4>`;
      listBox.appendChild(h);

      const wrap = document.createElement('div');
      wrap.className='cards';
      listBox.appendChild(wrap);

      items.forEach(o=>{
        const icon = ext(o.name)==='pdf' ? 'PDF' : (['ppt','pptx'].includes(ext(o.name)) ? 'PPT' : 'FILE');
        const card = document.createElement('div');
        card.className='card';
        card.innerHTML = `
          <div class="row">
            <div class="icon">${icon}</div>
            <div style="min-width:0">
              <div class="title">${nice(o.name)}</div>
              <div class="date">${fmt(o.updated_at||o.created_at)}</div>
            </div>
          </div>
          <button class="button small" data-path="${o.name}">Ver</button>
        `;
        wrap.appendChild(card);
      });
    });
  }

  function applyFilters(){
    const dir = orderSel.value==='asc' ? 1 : -1;
    filtered = allFiles.slice().sort((a,b)=> (new Date(a.updated_at||a.created_at) - new Date(b.updated_at||b.created_at)) * dir);
    const qv = q.value.trim().toLowerCase();
    if(qv) filtered = filtered.filter(o => nice(o.name).toLowerCase().includes(qv));
    render();
  }

  async function loadList(){
    const { data, error } = await supabaseClient.storage.from(BUCKET).list('', { limit:1000 });
    if(error){ listBox.innerHTML=''; emptyMsg.style.display='block'; return; }
    allFiles = data || [];
    applyFilters();
  }

  async function showFile(path){
    const { data, error } = await supabaseClient.storage.from(BUCKET).createSignedUrl(path, 300);
    if(error){ alert('No se pudo abrir el informe'); return; }
    const url = data.signedUrl;
    const e = ext(path);
    let viewerURL = '';
    if(e==='pdf'){
      viewerURL = url + '#toolbar=0&navpanes=0&scrollbar=0';
    } else if(e==='ppt' || e==='pptx'){
      viewerURL = 'https://view.officeapps.live.com/op/embed.aspx?src='+encodeURIComponent(url)+'&wdDownloadButton=False&wdPrint=0';
    } else {
      alert('Formato no soportado para visor: '+e); return;
    }
    currentURL = viewerURL;
    btnTab.href = currentURL;
    filename.textContent = nice(path);
    preview.src = viewerURL;
    preview.style.display='block';
  }

  // Fullscreen
  btnFull.addEventListener('click', async ()=>{
    try{
      if(!document.fullscreenElement){ await viewer.requestFullscreen(); }
      else{ await document.exitFullscreen(); }
    }catch(_){}
    viewer.classList.toggle('tall');
  });

  // Auth
  async function refreshUI(){
    const { data:{ session } } = await supabaseClient.auth.getSession();
    const user = session?.user || null;
    if(!user){
      authBox.style.display='block'; userBox.style.display='none'; tools.style.display='none';
      listBox.innerHTML=''; emptyMsg.style.display='block';
      preview.src=''; preview.style.display='none';
      filename.textContent = 'Selecciona un informe para visualizarlo.';
      btnTab.removeAttribute('href');
      return;
    }
    const email = (user.email||'').toLowerCase();
    if(!ALLOWLIST.includes(email)){ alert('Email no autorizado'); await supabaseClient.auth.signOut(); return; }
    authBox.style.display='none'; userBox.style.display='flex'; tools.style.display='flex';
    userEmail.textContent = email;
    await loadList();
  }

  // Eventos
  listBox.addEventListener('click', (e)=>{
    const b = e.target.closest('button[data-path]'); if(!b) return;
    showFile(b.getAttribute('data-path'));
  });
  q.addEventListener('input', applyFilters);
  orderSel.addEventListener('change', applyFilters);

  btnLogin.addEventListener('click', async ()=>{
    await supabaseClient.auth.signInWithOAuth({
      provider: 'google',
      options:{ redirectTo: location.origin + location.pathname, queryParams:{ access_type:'offline', prompt:'consent' } }
    });
  });
  btnLogout.addEventListener('click', async ()=>{
    await supabaseClient.auth.signOut(); await refreshUI();
  });

  // Init
  (async function(){
    if (/[?&]code=/.test(location.href)) {
      await supabaseClient.auth.exchangeCodeForSession(location.href);
      history.replaceState({}, '', location.origin + location.pathname);
    }
    if(location.hash.includes('access_token')) history.replaceState({},'',location.pathname);
    await refreshUI();
    supabaseClient.auth.onAuthStateChange(refreshUI);
  })();
</script>
</body>
</html>

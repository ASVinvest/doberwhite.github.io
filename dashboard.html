<!DOCTYPE html>
<html lang="es">
<head>
  <!-- Gate: SOLO admin o main -->
  <script>
  (function(){
    const ok    = localStorage.getItem('dw_auth') === 'ok';
    const scope = (localStorage.getItem('dw_scope') || '').trim().toLowerCase();
    let   home  = (localStorage.getItem('dw_home')  || '').trim();
    if(!home) home = (scope === 'small' ? 'dashboard_s.html' : 'dashboard.html');

    if(!ok){
      location.href = 'login.html?next=' + encodeURIComponent('dashboard.html');
      return;
    }

    const allow = (scope === 'admin' || scope === 'main');
    if(!allow){
      const here = location.pathname.split('/').pop() || 'dashboard.html';
      if (here !== home) location.replace(home);
    }
  })();
  </script>

  <meta charset="utf-8">
  <title>Dashboard — DoberWhite Capital</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="assets/css/main.css">

  <style>
    :root{ --dw-green:#00e18e; --dw-border:#e7eaf0; --dw-text:#111; --dw-muted:#6b7280; }
    body{background:#fff;color:var(--dw-text)}
    .dw-wrap{padding:16px}
    .dw-layout{display:grid;grid-template-columns:320px 1fr;gap:16px}
    .dw-aside{background:#fff;border:1px solid var(--dw-border);border-radius:12px;padding:14px}
    .dw-aside h4{margin:0 0 8px;font-weight:700}
    .dw-kpis{list-style:none;margin:0;padding:0;border-top:2px solid #111}
    .dw-kpis li{display:flex;justify-content:space-between;gap:12px;padding:10px 0;border-bottom:1px solid #e6e6e6}
    .dw-kpis li span:first-child{color:var(--dw-muted)}
    .dw-kpis li span:last-child{font-variant-numeric:tabular-nums}
    .dw-kpis .neg{color:#c62828}
    .dw-section{margin-top:6px}
    .dw-subtitle{font-style:italic;font-weight:700;text-align:center;margin:0 0 6px;color:#222;opacity:.9}
    .dw-grid{display:grid;gap:16px;grid-template-columns:repeat(12,1fr)}
    .dw-card{grid-column:span 4;background:#fff;border:1px solid var(--dw-border);border-radius:12px;
             box-shadow:0 2px 8px rgba(17,24,39,.06)}
    .dw-card h3{margin:12px 14px 0;font-weight:700}
    .dw-chart{height:260px;width:100%}
    @media (max-width:1100px){.dw-card{grid-column:span 6}.dw-layout{grid-template-columns:1fr}}
    @media (max-width:700px){.dw-card{grid-column:span 12}.dw-chart{height:220px}}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

  <!-- ===== Overrides estéticos mínimos (paleta Allocation) ===== -->
  <script>
  (function(){
    // Paleta fija para "Allocation" (por si la usa tu dashboard.js)
    window.DW_PIE_MAP = {
      'XAUUSD':'#86efac', // verde claro
      'BTCUSD':'#ef4444', // rojo
      'NDX100':'#fb923c', // naranjo
      'NAS100':'#fb923c', // alias mismo color
      'USDJPY':'#22d3ee', // cian
      'GBPUSD':'#60a5fa',
      'EURUSD':'#f59e0b'
    };
  })();
  </script>
  <!-- ===== Fin overrides ===== -->
</head>
<body>
  <script src="assets/js/main.js" defer></script>
  <script src="assets/js/logout.js" defer></script>

  <!-- Header -->
  <header class="site-header">
    <div class="container bar">
      <a class="brand" href="index.html"><span class="word">DOBERWHITE</span> <span class="thin">CAPITAL</span></a>
      <a class="menu-button" href="#menu">Menú</a>
    </div>

    <!-- Barra de usuario -->
    <div class="container mini" style="display:flex;justify-content:flex-end;gap:12px;align-items:center;margin-top:8px">
      <span id="dw-user" style="opacity:.75"></span>
      <button id="dw-logout"
              style="border:1px solid var(--line);background:var(--panel);color:var(--ink);
                     padding:6px 10px;border-radius:10px;cursor:pointer">
        Cerrar sesión
      </button>
    </div>
  </header>

  <!-- Menú (esta página) -->
  <nav class="site-menu" id="menu" aria-hidden="true">
    <div class="inner">
      <ul>
        <li><a href="index.html">Inicio</a></li>
        <li><a href="institucionales.html">Servicios institucionales</a></li>
        <li><a href="particulares.html">Servicios particulares</a></li>
        <li><a href="cursos.html">Cursos & seminarios</a></li>
        <li><a href="valores.html">Nuestros valores</a></li>
        <li class="active"><a href="dashboard.html">Dashboard</a></li>
        <li><a class="primary" href="contacto.html">Agendar reunión</a></li>
      </ul>
    </div>
  </nav>

  <!-- Hero -->
  <section class="hero" style="background:#fff;color:#111;border-bottom:1px solid #eee">
    <div class="container">
      <h1 style="color:#111">Dashboard</h1>
      <p class="sub" id="dw-periodo" style="color:#444">Performance SYNC</p>
    </div>
  </section>

  <!-- Dashboard -->
  <section class="dw-wrap">
    <div class="container">
      <div class="dw-layout">
        <aside class="dw-aside">
          <div class="dw-subtitle">Ratio <span style="font-weight:400">YTD</span></div>
          <ul id="dw-kpis" class="dw-kpis"></ul>
        </aside>

        <div>
          <div class="dw-section">
            <div class="dw-subtitle">P&L</div>
            <div class="dw-grid">
              <div class="dw-card"><h3>Balance USD</h3><div id="ch_balance" class="dw-chart"></div></div>
              <div class="dw-card"><h3>Montly USD</h3><div id="ch_monthly" class="dw-chart"></div></div>
              <div class="dw-card"><h3>Distribution USD</h3><div id="ch_distribution" class="dw-chart"></div></div>
            </div>
          </div>

          <div class="dw-section">
            <div class="dw-subtitle">Assets</div>
            <div class="dw-grid">
              <div class="dw-card"><h3>Allocation</h3><div id="ch_allocation" class="dw-chart"></div></div>
              <div class="dw-card"><h3>P&L USD(Neto)</h3><div id="ch_pl_assets" class="dw-chart"></div></div>
              <div class="dw-card"><h3>Win rate</h3><div id="ch_wr_assets" class="dw-chart"></div></div>
            </div>
          </div>

          <div class="dw-section">
            <div class="dw-subtitle">Miscellaneous</div>
            <div class="dw-grid">
              <div class="dw-card"><h3>Distribution trading days</h3><div id="ch_days_dist" class="dw-chart"></div></div>
              <div class="dw-card"><h3>Performance day</h3><div id="ch_days_perf" class="dw-chart"></div></div>
              <div class="dw-card"><h3>Average Position</h3><div id="ch_avg_pos" class="dw-chart"></div></div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </section>

  <footer class="site-footer" style="background:#fff;color:#111;border-top:1px solid #eee">
    <div class="container mini">
      <div>El rendimiento pasado no garantiza resultados futuros. Invertir implica riesgo de perder.</div>
      <div style="margin-top:8px">&copy; DoberWhite 2025 · Design: Ariel Salazar</div>
    </div>
  </footer>

  <!-- Render (usa data.json por defecto) -->
  <script src="/assets/js/dashboard.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <script src="/assets/js/dashboard.js?v=2025-10-28-03"></script>

  <!-- Profitability a 1 decimal -->
  <script>
    (async function () {
      const nf1 = new Intl.NumberFormat('es-CL', { minimumFractionDigits: 1, maximumFractionDigits: 1 });
      let json = null;
      try {
        const res = await fetch('assets/data/dashboard/data.json');
        if (res.ok) json = await res.json();
      } catch (e) {}
      function apply(val) {
        const ul = document.getElementById('dw-kpis');
        if (!ul) return false;
        const li = [...ul.querySelectorAll('li')]
          .find(x => x.querySelector('span:first-child')?.textContent?.trim() === 'Profitability');
        if (!li) return false;
        const value = Number(val);
        if (!Number.isFinite(value)) return false;
        li.querySelector('span:last-child').textContent = nf1.format(value) + '%';
        return true;
      }
      if (json && json.kpis && typeof json.kpis["Profitability"] === 'number') {
        if (apply(json.kpis["Profitability"])) return;
      }
      const ul = document.getElementById('dw-kpis');
      if (!ul) return;
      const obs = new MutationObserver(() => {
        if (json?.kpis?.["Profitability"] != null && apply(json.kpis["Profitability"])) {
          obs.disconnect();
        }
      });
      obs.observe(ul, { childList: true, subtree: true, characterData: true });
    })();
  </script>

  <!-- ===== PARCHE POST-RENDER: quitar TODAS las líneas internas de todos los gráficos ===== -->
  <script>
    (function(){
      const IDS = [
        'ch_balance','ch_monthly','ch_distribution',
        'ch_pl_assets','ch_wr_assets','ch_days_dist','ch_days_perf','ch_avg_pos'
      ];

      function stripAllLinesFromOption(opt){
        const handleAxis = (ax) => {
          if(!ax) return;
          const list = Array.isArray(ax) ? ax : [ax];
          list.forEach(a=>{
            a.splitLine = { show:false };
            a.axisLine  = { show:false };
            a.axisTick  = { show:false };
            // NO tocamos a.axisLabel (solo líneas)
          });
        };
        handleAxis(opt.xAxis);
        handleAxis(opt.yAxis);
        return opt;
      }

      function patchOne(id){
        const el = document.getElementById(id);
        if(!el) return false;
        const inst = echarts.getInstanceByDom(el);
        if(!inst) return false;
        const opt = inst.getOption ? inst.getOption() : null;
        if(!opt) return false;
        inst.setOption(stripAllLinesFromOption(opt), true);
        return true;
      }

      function patchAll(){
        let ok = true;
        for (const id of IDS){
          ok = patchOne(id) && ok;
        }
        return ok;
      }

      // Reintentos hasta que los charts existan
      let tries = 0;
      const timer = setInterval(()=>{
        const done = patchAll();
        tries++;
        if (done || tries > 40) clearInterval(timer);
      }, 150);

      // Reaplicar al redimensionar (por si se re-renderiza)
      window.addEventListener('resize', () => {
        setTimeout(patchAll, 200);
      });
    })();
  </script>
  <!-- ===== FIN PARCHE ===== -->
</body>
</html>

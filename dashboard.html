<!DOCTYPE html>
<html lang="es">
<head>
  <!-- Gate: SOLO admin o main -->
  <script>
  (function(){
    const ok    = localStorage.getItem('dw_auth') === 'ok';
    const scope = (localStorage.getItem('dw_scope') || '').trim().toLowerCase();
    let   home  = (localStorage.getItem('dw_home')  || '').trim();
    if(!home) home = (scope === 'small' ? 'dashboard_s.html' : 'dashboard.html');

    if(!ok){
      location.href = 'login.html?next=' + encodeURIComponent('dashboard.html');
      return;
    }

    const allow = (scope === 'admin' || scope === 'main');
    if(!allow){
      const here = location.pathname.split('/').pop() || 'dashboard.html';
      if (here !== home) location.replace(home);
    }
  })();
  </script>

  <meta charset="utf-8">
  <title>Dashboard — DoberWhite Capital</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="assets/css/main.css">

  <style>
    :root{
      --dw-green:#00e18e;
      --dw-border:#e7eaf0;
      --dw-text:#111;
      --dw-muted:#6b7280;
      --dw-red:#c62828;
      --dw-gray:#cbd5e1;
    }
    body{background:#fff;color:var(--dw-text)}
    .dw-wrap{padding:16px}
    .dw-layout{display:grid;grid-template-columns:320px 1fr;gap:16px}
    .dw-aside{background:#fff;border:1px solid var(--dw-border);border-radius:12px;padding:14px}
    .dw-aside h4{margin:0 0 8px;font-weight:700}
    .dw-kpis{list-style:none;margin:0;padding:0;border-top:2px solid #111}
    .dw-kpis li{display:flex;justify-content:space-between;gap:12px;padding:10px 0;border-bottom:1px solid #e6e6e6}
    .dw-kpis li span:first-child{color:var(--dw-muted)}
    .dw-kpis li span:last-child{font-variant-numeric:tabular-nums}
    .dw-kpis li span.neg{color:var(--dw-red)}
    .dw-section{margin-top:6px}
    .dw-subtitle{font-style:italic;font-weight:700;text-align:center;margin:0 0 6px;color:#222;opacity:.9}
    .dw-grid{display:grid;gap:16px;grid-template-columns:repeat(12,1fr)}
    .dw-card{grid-column:span 4;background:#fff;border:1px solid var(--dw-border);border-radius:12px;
             box-shadow:0 2px 8px rgba(17,24,39,.06)}
    .dw-card h3{margin:12px 14px 0;font-weight:700}
    .dw-chart{height:260px;width:100%}
    @media (max-width:1100px){.dw-card{grid-column:span 6}.dw-layout{grid-template-columns:1fr}}
    @media (max-width:700px){.dw-card{grid-column:span 12}.dw-chart{height:220px}}
  </style>

  <!-- ECharts -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

  <!-- Fuerza la fuente de datos para el dashboard principal -->
  <script> window.DW_DATA_URL = 'assets/data/dashboard/data.json'; </script>

  <!-- ================== OVERRIDES ESTÉTICOS (no intrusivos) ================== -->
  <script>
    (function(){
      // Paleta fija para Allocation (verde claro, rojo, naranjo, cian)
      const PIE_PALETTE = ['#86efac','#f87171','#fb923c','#22d3ee'];

      const BRAND = getComputedStyle(document.documentElement).getPropertyValue('--dw-green').trim() || '#00e18e';
      const RED   = '#ef9a9a';
      const GRAY  = getComputedStyle(document.documentElement).getPropertyValue('--dw-gray').trim() || '#cbd5e1';
      const TXT   = '#444';

      const nf = new Intl.NumberFormat('es-CL', { maximumFractionDigits: 2 });
      const nf1 = new Intl.NumberFormat('es-CL', { minimumFractionDigits: 1, maximumFractionDigits: 1 });

      // 1) Marcar en rojo todos los negativos del panel KPIs
      function paintNegatives(){
        const ul = document.getElementById('dw-kpis');
        if(!ul) return;
        [...ul.querySelectorAll('li span:last-child')].forEach(s=>{
          const t = s.textContent || '';
          if (t.includes('-')) s.classList.add('neg');
        });
      }
      // observar mutaciones porque el UL se pinta después
      new MutationObserver(paintNegatives).observe(document.body, {subtree:true, childList:true});

      // 2) Monkey-patch a echarts.init().setOption() para ajustar estilos por gráfico
      const _init = echarts.init;
      echarts.init = function(dom, theme, opts){
        const chart = _init(dom, theme, opts);
        const _set = chart.setOption.bind(chart);
        chart.setOption = function(option, ...rest){
          try{
            const id = (dom && dom.id) || '';
            if (!option) return _set(option, ...rest);

            // helper: fuerza sin líneas internas y ejes consistentes
            const tidyAxes = (opt, showYLabels=false) => {
              const axes = Array.isArray(opt.yAxis) ? opt.yAxis : [opt.yAxis || {}];
              const xaxes = Array.isArray(opt.xAxis) ? opt.xAxis : [opt.xAxis || {}];
              axes.forEach(a=>{
                a.splitLine = {show:false};
                a.axisTick = {show:false};
                a.axisLine = {lineStyle:{color:'#9aa0a6'}};
                a.axisLabel = Object.assign({show:showYLabels, color:'#555'}, a.axisLabel||{});
              });
              xaxes.forEach(a=>{
                a.splitLine = {show:false};
                a.axisTick = {show:false};
                a.axisLine = {lineStyle:{color:'#9aa0a6'}};
                a.axisLabel = Object.assign({color:'#555'}, a.axisLabel||{});
              });
              opt.yAxis = Array.isArray(opt.yAxis) ? axes : axes[0];
              opt.xAxis = Array.isArray(opt.xAxis) ? xaxes : xaxes[0];
            };

            // --- Defaults para TODOS ---
            tidyAxes(option, id === 'ch_balance'); // solo Balance muestra Y labels
            option.grid = Object.assign({left:36, right:16, top:36, bottom:28, containLabel:true}, option.grid||{});

            // --- Gráfico específico: Allocation (pie) ---
            if (id === 'ch_allocation' && option.series){
              option.color = PIE_PALETTE.slice(); // fuerza paleta
              option.series.forEach(s=>{
                if(s.type === 'pie'){
                  s.radius = s.radius || ['46%','68%'];
                  s.label = {show:false};
                }
              });
              option.legend = Object.assign({
                bottom:0, textStyle:{color:TXT}, itemWidth:12, itemHeight:12
              }, option.legend||{});
            }

            // --- Distribution USD: un solo eje, barras n° (gris) + P&L (verde/rojo) con etiquetas visibles ---
            if (id === 'ch_distribution' && option.series){
              // intenta detectar cuál serie es count y cuál es pnl por tamaño/signos
              let sCount = option.series[0], sPnl = option.series[1];
              if (sCount && sPnl && Array.isArray(sPnl.data) && Array.isArray(sCount.data)) {
                const maxCount = Math.max(...sCount.data.map(Number), 0);
                const minPnl   = Math.min(...sPnl.data.map(Number), 0);
                const head = Math.ceil(Math.max(maxCount, Math.abs(minPnl)) * 1.15);

                option.yAxis = {type:'value', min:-head, max:head, splitLine:{show:false}, axisLabel:{show:false}, axisTick:{show:false}, axisLine:{lineStyle:{color:'#9aa0a6'}}};

                // estilos serie n°
                sCount.type = 'bar';
                sCount.itemStyle = {color:GRAY};
                sCount.barMaxWidth = 26;
                sCount.label = {show:true, position:'top', color:TXT, formatter:(p)=> nf(p.value)};

                // estilos serie P&L
                sPnl.type = 'bar';
                sPnl.barMaxWidth = 26;
                sPnl.itemStyle = {color:(p)=> (Number(p.value)<0 ? RED : BRAND)};
                sPnl.label = {show:true, position:(p)=> Number(p.value)<0?'bottom':'top', color:TXT, formatter:(p)=> nf(p.value)};
                option.series = [sCount, sPnl];
                option.legend = Object.assign({top:6, right:8, textStyle:{color:TXT}}, option.legend||{});
              }
            }

            // --- Monthly: colorea positivos/negativos coherentes con marca ---
            if (id === 'ch_monthly' && option.series){
              option.series.forEach(s=>{
                if (s.type === 'bar' || s.type === 'pictorialBar'){
                  s.itemStyle = {color:(p)=> (Number(p.value)<0 ? RED : BRAND)};
                  s.label = s.label || {};
                  s.label.show = true;
                  s.label.position = (p)=> Number(p.value)<0 ? 'bottom':'top';
                  s.label.color = TXT;
                  s.label.formatter = (p)=> nf(p.value);
                }
              });
            }

            // --- Win rate / Distribution trading days / Performance day: etiquetas en % ---
            const asPercent = (id === 'ch_wr_assets' || id === 'ch_days_dist' || id === 'ch_days_perf');
            if (asPercent && option.series){
              option.series.forEach(s=>{
                if (s.type === 'bar' || s.type === 'line'){
                  s.label = Object.assign({show:true, color:TXT, position:'top', formatter:(p)=> `${nf(p.value)}%`}, s.label||{});
                }
              });
              // oculta Y labels (igual ya está oculto por tidyAxes)
              if (option.yAxis && !Array.isArray(option.yAxis)){
                option.yAxis.axisLabel = {show:false};
              }
            }

            // --- Average Position: evita recorte a la derecha y muestra etiquetas legibles ---
            if (id === 'ch_avg_pos'){
              option.grid = Object.assign({}, option.grid, {right:48, containLabel:true});
              if (option.series){
                option.series.forEach(s=>{
                  if (s.type === 'bar'){
                    s.label = Object.assign({show:true, position:'right', color:TXT, formatter:(p)=> nf(p.value)}, s.label||{});
                    s.barMaxWidth = 20;
                  }
                });
              }
            }

            // --- PL por activo: etiquetas numéricas finas ---
            if (id === 'ch_pl_assets' && option.series){
              option.series.forEach(s=>{
                if (s.type === 'bar'){
                  s.label = Object.assign({show:true, position:(p)=> Number(p.value)<0?'left':'right', color:TXT, formatter:(p)=> nf(p.value)}, s.label||{});
                  s.itemStyle = {color:(p)=> (Number(p.value)<0 ? RED : BRAND)};
                }
              });
            }

          }catch(e){ /* silencio para no romper flujo si dashboard.js cambia */ }
          return _set(option, ...rest);
        };
        return chart;
      };
    })();
  </script>
  <!-- ================== /OVERRIDES ================== -->
</head>
<body>
  <script src="assets/js/main.js" defer></script>
  <script src="assets/js/logout.js" defer></script>

  <!-- Header -->
  <header class="site-header">
    <div class="container bar">
      <a class="brand" href="index.html"><span class="word">DOBERWHITE</span> <span class="thin">CAPITAL</span></a>
      <a class="menu-button" href="#menu">Menú</a>
    </div>

    <!-- Barra de usuario -->
    <div class="container mini" style="display:flex;justify-content:flex-end;gap:12px;align-items:center;margin-top:8px">
      <span id="dw-user" style="opacity:.75"></span>
      <button id="dw-logout"
              style="border:1px solid var(--line);background:var(--panel);color:var(--ink);
                     padding:6px 10px;border-radius:10px;cursor:pointer">
        Cerrar sesión
      </button>
    </div>
  </header>

  <!-- Menú (esta página) -->
  <nav class="site-menu" id="menu" aria-hidden="true">
    <div class="inner">
      <ul>
        <li><a href="index.html">Inicio</a></li>
        <li><a href="institucionales.html">Servicios institucionales</a></li>
        <li><a href="particulares.html">Servicios particulares</a></li>
        <li><a href="cursos.html">Cursos & seminarios</a></li>
        <li><a href="valores.html">Nuestros valores</a></li>
        <li class="active"><a href="dashboard.html">Dashboard</a></li>
        <li><a class="primary" href="contacto.html">Agendar reunión</a></li>
      </ul>
    </div>
  </nav>

  <!-- Hero -->
  <section class="hero" style="background:#fff;color:#111;border-bottom:1px solid #eee">
    <div class="container">
      <h1 style="color:#111">Dashboard</h1>
      <p class="sub" id="dw-periodo" style="color:#444">Performance SYNC</p>
    </div>
  </section>

  <!-- Dashboard -->
  <section class="dw-wrap">
    <div class="container">
      <div class="dw-layout">
        <aside class="dw-aside">
          <div class="dw-subtitle">Ratio <span style="font-weight:400">YTD</span></div>
          <ul id="dw-kpis" class="dw-kpis"></ul>
        </aside>

        <div>
          <div class="dw-section">
            <div class="dw-subtitle">P&L</div>
            <div class="dw-grid">
              <div class="dw-card"><h3>Balance USD</h3><div id="ch_balance" class="dw-chart"></div></div>
              <div class="dw-card"><h3>Montly USD</h3><div id="ch_monthly" class="dw-chart"></div></div>
              <div class="dw-card"><h3>Distribution USD</h3><div id="ch_distribution" class="dw-chart"></div></div>
            </div>
          </div>

          <div class="dw-section">
            <div class="dw-subtitle">Assets</div>
            <div class="dw-grid">
              <div class="dw-card"><h3>Allocation</h3><div id="ch_allocation" class="dw-chart"></div></div>
              <div class="dw-card"><h3>P&L USD(Neto)</h3><div id="ch_pl_assets" class="dw-chart"></div></div>
              <div class="dw-card"><h3>Win rate</h3><div id="ch_wr_assets" class="dw-chart"></div></div>
            </div>
          </div>

          <div class="dw-section">
            <div class="dw-subtitle">Miscellaneous</div>
            <div class="dw-grid">
              <div class="dw-card"><h3>Distribution trading days</h3><div id="ch_days_dist" class="dw-chart"></div></div>
              <div class="dw-card"><h3>Performance day</h3><div id="ch_days_perf" class="dw-chart"></div></div>
              <div class="dw-card"><h3>Average Position</h3><div id="ch_avg_pos" class="dw-chart"></div></div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </section>

  <footer class="site-footer" style="background:#fff;color:#111;border-top:1px solid #eee">
    <div class="container mini">
      <div>El rendimiento pasado no garantiza resultados futuros. Invertir implica riesgo de perder.</div>
      <div style="margin-top:8px">&copy; DoberWhite 2025 · Design: Ariel Salazar</div>
    </div>
  </footer>

  <!-- Render principal -->
  <script src="assets/js/dashboard.js"></script>

  <!-- Profitability a 1 decimal (lee data.json por defecto) + rojos en negativos si cambia tardiamente -->
  <script>
    (async function () {
      const nf1 = new Intl.NumberFormat('es-CL', { minimumFractionDigits: 1, maximumFractionDigits: 1 });
      let json = null;
      try {
        const res = await fetch(window.DW_DATA_URL || 'assets/data/dashboard/data.json', {cache:'no-store'});
        if (res.ok) json = await res.json();
      } catch (e) {}
      function apply(val) {
        const ul = document.getElementById('dw-kpis');
        if (!ul) return false;
        const li = [...ul.querySelectorAll('li')]
          .find(x => x.querySelector('span:first-child')?.textContent?.trim() === 'Profitability');
        if (!li) return false;
        const value = Number(val);
        if (!Number.isFinite(value)) return false;
        const target = li.querySelector('span:last-child');
        target.textContent = nf1.format(value) + '%';
        if (value < 0) target.classList.add('neg');
        return true;
      }
      if (json?.kpis && typeof json.kpis["Profitability"] === 'number') {
        if (apply(json.kpis["Profitability"])) return;
      }
      const ul = document.getElementById('dw-kpis');
      if (!ul) return;
      const obs = new MutationObserver(() => {
        if (json?.kpis?.["Profitability"] != null && apply(json.kpis["Profitability"])) {
          obs.disconnect();
        }
      });
      obs.observe(ul, { childList: true, subtree: true, characterData: true });
    })();
  </script>
</body>
</html>

<script>
  (async () => {
    // A) Cargar datos
    const res = await fetch('./assets/data/dashboard/data.json'); // <- ruta correcta
    if (!res.ok) { console.error('No se encontró data.json', res.status); return; }
    const data = await res.json();
  
    // B) KPIs (Profitability con 1 decimal)
    const list = document.getElementById('dw-kpis');
    const nf0 = new Intl.NumberFormat('es-CL',{maximumFractionDigits:0});
    const nf1 = new Intl.NumberFormat('es-CL',{minimumFractionDigits:1,maximumFractionDigits:1});
    const order = ["Win Rate","Profitability","Risk Benefit","N° Trades","N° Trades Win","N° Trades Loss",
                   "P&L (USD)","Win Average","Loss Average","WipeOut","% Average SL","Comission"];
    list.innerHTML = '';
    order.forEach(k=>{
      let v = data.kpis[k];
      if (k==="Profitability") v = nf1.format(v)+"%";
      else if (k==="Win Rate"||k==="WipeOut"||k==="% Average SL") v = nf0.format(v)+"%";
      else if (k==="P&L (USD)") v = "$ "+nf0.format(v);
      list.insertAdjacentHTML('beforeend', `<li><span>${k}</span><span>${v}</span></li>`);
    });
    const p = document.getElementById('dw-periodo');
    if (p) p.textContent = `From: ${data.period.from} → ${data.period.to}`;
  
    // C) Dibujar charts (ECharts DEBE estar cargado ya)
    if (!window.echarts) { console.error('ECharts no cargó'); return; }
    const $ = id => echarts.init(document.getElementById(id));
  
    $('#ch_balance').setOption({
      tooltip:{trigger:'axis'},
      xAxis:{type:'category',data:data.balance.labels},
      yAxis:{type:'value'},
      series:[{type:'bar',data:data.balance.values}]
    });
  
    $('#ch_monthly').setOption({
      tooltip:{trigger:'axis'},
      xAxis:{type:'category',data:data.monthly.labels},
      yAxis:{type:'value'},
      series:[{type:'bar',data:data.monthly.values,label:{show:true,position:'top'}}]
    });
  
    $('#ch_distribution').setOption({
      tooltip:{trigger:'axis'},
      legend:{data:['n°','Beneficio']},
      xAxis:{type:'category',data:data.distribution.labels},
      yAxis:[{type:'value',name:'n°'},{type:'value',name:'USD'}],
      series:[
        {name:'n°', type:'bar', data:data.distribution.counts, yAxisIndex:0},
        {name:'Beneficio', type:'bar', data:data.distribution.pnl, yAxisIndex:1}
      ]
    });
  
    $('#ch_allocation').setOption({
      tooltip:{trigger:'item',formatter:'{b}: {d}%'},
      series:[{type:'pie',radius:['45%','70%'],
        data:data.allocation.labels.map((l,i)=>({name:l,value:data.allocation.values[i]}))
      }]
    });
  
    $('#ch_pl_assets').setOption({
      tooltip:{trigger:'axis'},
      xAxis:{type:'value'},
      yAxis:{type:'category',data:data.plAssets.labels},
      series:[{type:'bar',data:data.plAssets.values}]
    });
  
    $('#ch_wr_assets').setOption({
      tooltip:{trigger:'axis',valueFormatter:v=>v+'%'},
      xAxis:{type:'category',data:data.wrAssets.labels},
      yAxis:{type:'value'},
      series:[{type:'bar',data:data.wrAssets.values,label:{show:true,position:'top',formatter:'{c}%'}}]
    });
  
    $('#ch_days_dist').setOption({
      tooltip:{trigger:'axis'},
      xAxis:{type:'category',data:data.daysDist.labels},
      yAxis:{type:'value'},
      series:[{type:'bar',data:data.daysDist.values}]
    });
  
    $('#ch_days_perf').setOption({
      tooltip:{trigger:'axis',valueFormatter:v=>v+'%'},
      xAxis:{type:'category',data:data.daysPerf.labels},
      yAxis:{type:'value'},
      series:[{type:'bar',data:data.daysPerf.values,label:{show:true,position:'top',formatter:'{c}%'}}]
    });
  
    $('#ch_avg_pos').setOption({
      tooltip:{trigger:'axis'},
      xAxis:{type:'value'},
      yAxis:{type:'category',data:data.avgPos.labels},
      series:[{type:'bar',data:data.avgPos.values,label:{show:true,position:'right'}}]
    });
  
    // D) Resize
    window.addEventListener('resize', () =>
      document.querySelectorAll('.dw-chart').forEach(n => echarts.getInstanceByDom(n)?.resize())
    );
  })();
  </script>
  
<!DOCTYPE html>
<html lang="es">
<head>
  <!-- Gate: SOLO admin o main -->
  <script>
  (function(){
    const ok    = localStorage.getItem('dw_auth') === 'ok';
    const scope = (localStorage.getItem('dw_scope') || '').trim().toLowerCase();
    let   home  = (localStorage.getItem('dw_home')  || '').trim();
    if(!home) home = (scope === 'small' ? 'dashboard_s.html' : 'dashboard.html');

    if(!ok){
      location.href = 'login.html?next=' + encodeURIComponent('dashboard.html');
      return;
    }

    const allow = (scope === 'admin' || scope === 'main');
    if(!allow){
      const here = location.pathname.split('/').pop() || 'dashboard.html';
      if (here !== home) location.replace(home);
    }
  })();
  </script>

  <meta charset="utf-8">
  <title>Dashboard — DoberWhite Capital</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="assets/css/main.css">

  <style>
    :root{ --dw-green:#00e18e; --dw-border:#e7eaf0; --dw-text:#111; --dw-muted:#6b7280; }
    body{background:#fff;color:var(--dw-text)}
    .dw-wrap{padding:16px}
    .dw-layout{display:grid;grid-template-columns:320px 1fr;gap:16px}
    .dw-aside{background:#fff;border:1px solid var(--dw-border);border-radius:12px;padding:14px}
    .dw-aside h4{margin:0 0 8px;font-weight:700}
    .dw-kpis{list-style:none;margin:0;padding:0;border-top:2px solid #111}
    .dw-kpis li{display:flex;justify-content:space-between;gap:12px;padding:10px 0;border-bottom:1px solid #e6e6e6}
    .dw-kpis li span:first-child{color:var(--dw-muted)}
    .dw-kpis li span:last-child{font-variant-numeric:tabular-nums}
    .dw-kpis .neg{color:#c62828}
    .dw-section{margin-top:6px}
    .dw-subtitle{font-style:italic;font-weight:700;text-align:center;margin:0 0 6px;color:#222;opacity:.9}
    .dw-grid{display:grid;gap:16px;grid-template-columns:repeat(12,1fr)}
    .dw-card{grid-column:span 4;background:#fff;border:1px solid var(--dw-border);border-radius:12px;
             box-shadow:0 2px 8px rgba(17,24,39,.06)}
    .dw-card h3{margin:12px 14px 0;font-weight:700}
    .dw-chart{height:260px;width:100%}
    @media (max-width:1100px){.dw-card{grid-column:span 6}.dw-layout{grid-template-columns:1fr}}
    @media (max-width:700px){.dw-card{grid-column:span 12}.dw-chart{height:220px}}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

  <!-- ===== Overrides estéticos (igual a dashboard_s) ===== -->
  <script>
  (function(){
    // Paleta fija para "Allocation" (verde claro, rojo, naranjo, cian)
    const PIE_MAP = {
      'XAUUSD':'#86efac', // verde claro
      'BTCUSD':'#ef4444', // rojo
      'NDX100':'#fb923c', // naranjo
      'NAS100':'#fb923c', // alias mismo color
      'USDJPY':'#22d3ee', // cian
      'GBPUSD':'#60a5fa', // respaldo si aparece en datos
      'EURUSD':'#f59e0b'
    };

    // Utilidad para remover TODA línea interna (y ejes) en cualquier opción
    function stripAllLines(opt, hideYAxisLabels = true) {
      // Eje X
      if (Array.isArray(opt.xAxis)) {
        opt.xAxis.forEach(ax => {
          ax.splitLine = { show:false };
          ax.axisLine  = { show:false };
          ax.axisTick  = { show:false };
        });
      } else if (opt.xAxis) {
        opt.xAxis.splitLine = { show:false };
        opt.xAxis.axisLine  = { show:false };
        opt.xAxis.axisTick  = { show:false };
      }
      // Eje Y
      if (Array.isArray(opt.yAxis)) {
        opt.yAxis.forEach(ax => {
          ax.splitLine = { show:false };
          ax.axisLine  = { show:false };
          ax.axisTick  = { show:false };
          if (hideYAxisLabels) ax.axisLabel = Object.assign({}, ax.axisLabel, { show:false });
        });
      } else if (opt.yAxis) {
        opt.yAxis.splitLine = { show:false };
        opt.yAxis.axisLine  = { show:false };
        opt.yAxis.axisTick  = { show:false };
        if (hideYAxisLabels) opt.yAxis.axisLabel = Object.assign({}, opt.yAxis.axisLabel, { show:false });
      }
      return opt;
    }

    // === Balance (único que mantiene etiquetas en eje Y) ===
    window.optLine = function(series, labels){
      const opt = {
        grid:{ left:36,right:10,top:20,bottom:28,containLabel:true },
        xAxis:{ type:'category', data:labels, axisLabel:{ color:'#666' } },
        yAxis:{ type:'value', axisLabel:{ color:'#666' } }, // <- mantiene valores
        series:[{
          type:'line', smooth:true, symbol:'circle', symbolSize:6,
          lineStyle:{ width:2 },
          areaStyle:{ color:'rgba(0,225,142,0.06)' },
          data:series
        }]
      };
      // Sin líneas internas (pero conserva labels de Y)
      return stripAllLines(opt, /*hideYAxisLabels=*/false);
    };

    // === Monthly USD ===
    window.optMonth = function(labels, values){
      const opt = {
        grid:{ left:28,right:10,top:24,bottom:24,containLabel:true },
        xAxis:{ type:'category', data:labels, axisLabel:{ color:'#666' } },
        yAxis:{ type:'value', axisLabel:{ show:false } },
        series:[{
          type:'bar', data:values,
          itemStyle:{ color:(p)=> p.value>=0 ? '#00e18e' : '#ef9a9a' },
          barMaxWidth:26,
          label:{ show:true, position:'top', formatter:(p)=>p.value, color:'#666' }
        }]
      };
      return stripAllLines(opt);
    };

    // === Distribution USD (barras dobles: n° y P&L) ===
    window.optDist = function(d){
      const brand = '#00e18e', red = '#ef9a9a', gray = '#cbd5e1';
      const maxCount = Math.max(...d.counts, 0);
      const minPnl   = Math.min(...d.pnl, 0);
      const maxAbs   = Math.max(maxCount, Math.abs(minPnl));
      const head     = Math.ceil(maxAbs * 1.15);

      const opt = {
        grid:{ left:28,right:10,top:36,bottom:28,containLabel:true },
        legend:{ top:6, right:6, data:['n°','P&L'] },
        tooltip:{ trigger:'axis' },
        xAxis:{ type:'category', data:d.labels, axisLabel:{ color:'#666', interval:0 } },
        yAxis:{ type:'value', min:-head, max:head, axisLabel:{ show:false } },
        series:[
          { name:'n°',  type:'bar', barMaxWidth:26, itemStyle:{ color:gray  },
            label:{ show:true, position:'top', color:'#666' }, data:d.counts, z:1 },
          { name:'P&L', type:'bar', barMaxWidth:26,
            itemStyle:{ color:(p)=> (p.value<0 ? red : brand) },
            label:{ show:true, position:(p)=>p.value>=0?'top':'bottom', color:'#666' },
            data:d.pnl, z:2, barGap:'40%' }
        ]
      };
      return stripAllLines(opt);
    };

    // === Allocation (donut con paleta fija) ===
    window.optPie = function(labels, values){
      const total = values.reduce((a,b)=>a+b,0) || 1;
      return {
        legend:{ bottom:0, itemWidth:12, itemHeight:12, textStyle:{ color:'#444' },
          formatter:(name)=>{ const i=labels.indexOf(name); const p=Math.round(values[i]*100/total); return `${name}  ${p}%`; } },
        tooltip:{ trigger:'item', formatter: ({name,percent}) => `${name}: ${percent}%` },
        series:[{
          type:'pie', radius:['46%','68%'], center:['50%','44%'], label:{ show:false },
          data: labels.map((n,i)=>({ name:n, value:values[i], itemStyle:{ color: PIE_MAP[n] || '#94a3b8' } }))
        }]
      };
    };

    // === P&L USD (Neto) por activo ===
    window.optBarPLAssets = function(labels, values){
      const opt = {
        grid:{ left:64,right:16,top:24,bottom:18,containLabel:true },
        xAxis:{ type:'value', axisLabel:{ show:false } },
        yAxis:{ type:'category', data:labels, axisLabel:{ color:'#666' } },
        series:[{
          type:'bar', data:values, barMaxWidth:22,
          itemStyle:{ color:(p)=> p.value>=0 ? '#00e18e' : '#ef9a9a' },
          label:{ show:true, position:(p)=>p.value>=0?'right':'left', formatter:(p)=>p.value, color:'#666' }
        }]
      };
      return stripAllLines(opt);
    };

    // === Win rate (en %) ===
    window.optBarWRAssets = function(labels, values){
      const opt = {
        grid:{ left:28,right:10,top:24,bottom:26,containLabel:true },
        xAxis:{ type:'category', data:labels, axisLabel:{ color:'#666' } },
        yAxis:{ type:'value', axisLabel:{ show:false }, max:100 },
        series:[{
          type:'bar', data:values, barMaxWidth:26, itemStyle:{ color:'#00e18e' },
          label:{ show:true, position:'top', formatter:(p)=>`${p.value}%`, color:'#666' }
        }]
      };
      return stripAllLines(opt);
    };

    // === Distribution trading days (en %) ===
    window.optDaysDist = function(labels, values){
      const opt = {
        grid:{ left:28,right:10,top:24,bottom:26,containLabel:true },
        xAxis:{ type:'category', data:labels, axisLabel:{ color:'#666' } },
        yAxis:{ type:'value', axisLabel:{ show:false }, max:100 },
        series:[{
          type:'bar', data:values, barMaxWidth:26, itemStyle:{ color:'#00e18e' },
          label:{ show:true, position:'top', formatter:(p)=>`${p.value}%`, color:'#666' }
        }]
      };
      return stripAllLines(opt);
    };

    // === Performance day (en %) ===
    window.optDaysPerf = function(labels, values){
      const opt = {
        grid:{ left:28,right:10,top:24,bottom:26,containLabel:true },
        xAxis:{ type:'category', data:labels, axisLabel:{ color:'#666' } },
        yAxis:{ type:'value', axisLabel:{ show:false }, max:100 },
        series:[{
          type:'bar', data:values, barMaxWidth:26, itemStyle:{ color:'#00e18e' },
          label:{ show:true, position:'top', formatter:(p)=>`${p.value}%`, color:'#666' }
        }]
      };
      return stripAllLines(opt);
    };

    // === Average Position (horizontal, evita corte de etiquetas) ===
    window.optAvgPos = function(labels, values){
      const opt = {
        grid:{ left:64,right:42,top:24,bottom:18,containLabel:true },
        xAxis:{ type:'value', axisLabel:{ show:false } },
        yAxis:{ type:'category', data:labels, axisLabel:{ color:'#666' } },
        series:[{
          type:'bar', data:values, barMaxWidth:16, itemStyle:{ color:'#00e18e' },
          label:{ show:true, position:'right', formatter:(p)=>p.value.toFixed(2), color:'#666' }
        }]
      };
      return stripAllLines(opt);
    };
  })();
  </script>
  <!-- ===== Fin overrides ===== -->
</head>
<body>
  <script src="assets/js/main.js" defer></script>
  <script src="assets/js/logout.js" defer></script>

  <!-- Header -->
  <header class="site-header">
    <div class="container bar">
      <a class="brand" href="index.html"><span class="word">DOBERWHITE</span> <span class="thin">CAPITAL</span></a>
      <a class="menu-button" href="#menu">Menú</a>
    </div>

    <!-- Barra de usuario -->
    <div class="container mini" style="display:flex;justify-content:flex-end;gap:12px;align-items:center;margin-top:8px">
      <span id="dw-user" style="opacity:.75"></span>
      <button id="dw-logout"
              style="border:1px solid var(--line);background:var(--panel);color:var(--ink);
                     padding:6px 10px;border-radius:10px;cursor:pointer">
        Cerrar sesión
      </button>
    </div>
  </header>

  <!-- Menú (esta página) -->
  <nav class="site-menu" id="menu" aria-hidden="true">
    <div class="inner">
      <ul>
        <li><a href="index.html">Inicio</a></li>
        <li><a href="institucionales.html">Servicios institucionales</a></li>
        <li><a href="particulares.html">Servicios particulares</a></li>
        <li><a href="cursos.html">Cursos & seminarios</a></li>
        <li><a href="valores.html">Nuestros valores</a></li>
        <li class="active"><a href="dashboard.html">Dashboard</a></li>
        <li><a class="primary" href="contacto.html">Agendar reunión</a></li>
      </ul>
    </div>
  </nav>

  <!-- Hero -->
  <section class="hero" style="background:#fff;color:#111;border-bottom:1px solid #eee">
    <div class="container">
      <h1 style="color:#111">Dashboard</h1>
      <p class="sub" id="dw-periodo" style="color:#444">Performance SYNC</p>
    </div>
  </section>

  <!-- Dashboard -->
  <section class="dw-wrap">
    <div class="container">
      <div class="dw-layout">
        <aside class="dw-aside">
          <div class="dw-subtitle">Ratio <span style="font-weight:400">YTD</span></div>
          <ul id="dw-kpis" class="dw-kpis"></ul>
        </aside>

        <div>
          <div class="dw-section">
            <div class="dw-subtitle">P&L</div>
            <div class="dw-grid">
              <div class="dw-card"><h3>Balance USD</h3><div id="ch_balance" class="dw-chart"></div></div>
              <div class="dw-card"><h3>Montly USD</h3><div id="ch_monthly" class="dw-chart"></div></div>
              <div class="dw-card"><h3>Distribution USD</h3><div id="ch_distribution" class="dw-chart"></div></div>
            </div>
          </div>

          <div class="dw-section">
            <div class="dw-subtitle">Assets</div>
            <div class="dw-grid">
              <div class="dw-card"><h3>Allocation</h3><div id="ch_allocation" class="dw-chart"></div></div>
              <div class="dw-card"><h3>P&L USD(Neto)</h3><div id="ch_pl_assets" class="dw-chart"></div></div>
              <div class="dw-card"><h3>Win rate</h3><div id="ch_wr_assets" class="dw-chart"></div></div>
            </div>
          </div>

          <div class="dw-section">
            <div class="dw-subtitle">Miscellaneous</div>
            <div class="dw-grid">
              <div class="dw-card"><h3>Distribution trading days</h3><div id="ch_days_dist" class="dw-chart"></div></div>
              <div class="dw-card"><h3>Performance day</h3><div id="ch_days_perf" class="dw-chart"></div></div>
              <div class="dw-card"><h3>Average Position</h3><div id="ch_avg_pos" class="dw-chart"></div></div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </section>

  <footer class="site-footer" style="background:#fff;color:#111;border-top:1px solid #eee">
    <div class="container mini">
      <div>El rendimiento pasado no garantiza resultados futuros. Invertir implica riesgo de perder.</div>
      <div style="margin-top:8px">&copy; DoberWhite 2025 · Design: Ariel Salazar</div>
    </div>
  </footer>

  <!-- Render (usa data.json por defecto) -->
  <script src="/assets/js/dashboard.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <script src="/assets/js/dashboard.js?v=2025-10-28-03"></script>

  <!-- Profitability a 1 decimal -->
  <script>
    (async function () {
      const nf1 = new Intl.NumberFormat('es-CL', { minimumFractionDigits: 1, maximumFractionDigits: 1 });
      let json = null;
      try {
        const res = await fetch('assets/data/dashboard/data.json');
        if (res.ok) json = await res.json();
      } catch (e) {}
      function apply(val) {
        const ul = document.getElementById('dw-kpis');
        if (!ul) return false;
        const li = [...ul.querySelectorAll('li')]
          .find(x => x.querySelector('span:first-child')?.textContent?.trim() === 'Profitability');
        if (!li) return false;
        const value = Number(val);
        if (!Number.isFinite(value)) return false;
        li.querySelector('span:last-child').textContent = nf1.format(value) + '%';
        return true;
      }
      if (json && json.kpis && typeof json.kpis["Profitability"] === 'number') {
        if (apply(json.kpis["Profitability"])) return;
      }
      const ul = document.getElementById('dw-kpis');
      if (!ul) return;
      const obs = new MutationObserver(() => {
        if (json?.kpis?.["Profitability"] != null && apply(json.kpis["Profitability"])) {
          obs.disconnect();
        }
      });
      obs.observe(ul, { childList: true, subtree: true, characterData: true });
    })();
  </script>
</body>
</html>
